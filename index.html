<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Document</title>

  <link rel="stylesheet" href="./style/reset.css">
  <link rel="stylesheet" href="./style/frame.css">
</head>
<body>

<div id="whole-wrapper" onclick="parse(++cursor)">

  <div id="character-wrapper"></div>
  <div id="chat-wrapper">
    <div id="name"></div>
    <div id="text-wrapper">
      <div id="text"></div>
      <div id="next">
        &gt;
      </div>
    </div>
    <div id="setting">
      <span onclick="qSave()">Quick SAVE</span>
      <span onclick="qLoad()">Quick Load</span>
      <span>Log</span>
      <span>Skip</span>
    </div>
  </div>
  <div id="selector-wrapper">
    <ul id="selector">
    </ul>
  </div>
</div>

<script>

  let cursor = 0;
  let currentPhase = "start";
  let bgImage = './images/default-bg.png'

  const favor = {
    "캐릭터1": 2,
    "캐릭터2": 0
  }

  const scenario = {
    "start": [
      {
        "text": "시작.",
        "bg": "./images/default-bg.png"
      },
      {
        "bg": "./images/cg.png",
      },
      {
        "text": "끝",
      },
    ]
  }


  const addFavor = (v) =>
    v.forEach(i => {
      if (!favor[i.name]) {
        favor[i.name] = i.cnt;
      } else {
        favor[i.name] += i.cnt;
      }
    })

  const jumping = (jump) => {
    currentPhase = jump
    cursor = 0;
    parse(0);
  }
  const handleSelect = (v) => {
    const {variable, jump} = JSON.parse(decodeURI(v))

    if (!!variable) {
      addFavor(variable)
    }
    //jump가 있으면 점프하고, 없으면 시나리오를 이어서 출력합니다.
    if (!!jump) {
      jumping(jump)
    } else {
      parse(++cursor)
    }
  }

  //조건을 만족하는것이 있는지를 찾습니다.
  const conditionCheck = (varCheck) => {
    const {state, value} = varCheck;

    const calc = (i) => {
      const c = favor[i.variable];
      switch (i.condition) {
        case "+":
          return c > i.cnt;
        case "-":
          return c < i.cnt;
        case "=":
          return c === i.cnt;
        default:
          return true;
      }
    }

    //OR이면 조건을 하나만 이라도 만족하는지를 체크하고
    //그외의 경우에는 만족하는것이 있는지를 체크합니다.
    switch (state) {
      case "OR":
        return !!value.find(i => calc(i))
      case "AND":
      default:
        return value.filter(i => calc(i)).length === value.length
    }
  }

  const qSave = () => {
    localStorage.setItem("qSave", JSON.stringify({cursor, currentPhase, favor, bgImage}))
  }
  const qLoad = () => {
    const save = JSON.parse(localStorage.getItem("qSave"))
    cursor = save.cursor;
    currentPhase = save.currentPhase;
    Object.assign(favor, save.favor)
    document.getElementById('whole-wrapper').style.backgroundImage = `url('${save.bgImage}')`;
    parse(save.cursor)
  }

  const display = (i) => {

    const {text, name, image, select, jump, bg} = scenario[currentPhase][i];

    //bg가 있으면 bg를 바꾼다.
    if (!!bg && bg !== bgImage) {
      document.getElementById('whole-wrapper').style.backgroundImage = `url('${bg}')`
      bgImage = bg;
    }

    //텍스트 유무에 따른 출력
    if (!!text) {
      document.getElementById('chat-wrapper').style.display = 'grid';
      document.getElementById('text').innerText = text;
    }

    //이름유무에 따른 출력
    if (!!name) {
      document.getElementById('name').style.display = 'grid';
      document.getElementById('name').innerText = name;
    }

    //이미지 유무에 따른 출력
    if (!!image) {
      document.getElementById('character-wrapper').innerHTML = `<img src="${image.src}" alt="${image.alt}"/>`
    }

    //선택지가 있으면 선택지를 출력 해 줍니다.
    if (!!select) {
      document.getElementById('selector-wrapper').style.display = 'grid';
      document.getElementById('selector').innerHTML = select.map(i => {
        // 선택지에서도 호감도 체크를 해 줍니다.
        if (!!i.varCheck && !conditionCheck(i.varCheck)) {
          return null
        } else {
          return `<li onclick="handleSelect('${encodeURI(JSON.stringify(i))}')">${i.text}</li>`
        }
      }).join('')
    }
    //jump가 있으면 해당 시나리오 오브젝트로 이동합니다.
    if (!!jump) {
      jumping(jump);
    }

    //커서가 시나리오의 끝에 오면 화살표를 지웁니다. 점프가 있으면 뒤가 이어지니 계속 출력합니다.
    if (scenario[currentPhase].length - 1 === cursor && !jump) {
      document.getElementById('next').style.display = 'none';
    }
  }

  const parse = (i = 0) => {

    const {varCheck} = scenario[currentPhase][i];

    //화면을 초기화 해줍니다.
    document.getElementById('name').style.display = 'none';
    document.getElementById('selector-wrapper').style.display = 'none';
    document.getElementById('chat-wrapper').style.display = 'none';
    document.getElementById('character-wrapper').innerHTML = null;


    // 호감도 체크가 있으면 호감도를 체크 해 줍니다.
    if (!!varCheck && !conditionCheck(varCheck)) {
      parse(++cursor)
    } else {
      // 호감도 체크가 없으면 화면을 그냥 띄워줍니다.
      display(cursor)
    }
  }

  const init = () => {
    cursor = 0;
    currentPhase = "start";
    document.getElementById('whole-wrapper').style.backgroundImage = `url('${bgImage}')`;
    for (const prop of Object.getOwnPropertyNames(favor)) {
      delete favor[prop];
    }
    parse(cursor);
  }

  init();


</script>
</body>
</html>
